<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포트폴리오 리밸런싱 계산기</title>
    <meta name="description" content="포트폴리오 리밸런싱 계산기를 통해 목표 비율에 맞춰 투자 전략을 최적화하세요.">

    <!-- Content Security Policy: Strict CSP with no unsafe directives -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' blob:;
        style-src 'self';
        img-src 'self' data: https:;
        font-src 'self' data:;
        connect-src 'self' https://finnhub.io https://api.exchangerate-api.com;
        base-uri 'self';
        form-action 'self';
        object-src 'none';
    ">

    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="aria-announcer" class="visually-hidden" aria-live="assertive" aria-atomic="true"></div>

    <button id="darkModeToggle" class="btn dark-mode-toggle" aria-label="다크 모드 전환">🌙</button>
    <div class="container">
        <header class="header">
            <h1>📊 포트폴리오 리밸런싱 계산기</h1>
            <p>목표 비율에 맞춰 포트폴리오를 조정하는 최적의 방법을 계산합니다.</p>
        </header>

        <main>
            <section class="card" aria-labelledby="portfolioManagementHeading">
                <h2 id="portfolioManagementHeading">📁 포트폴리오 관리</h2>
                <div class="input-group">
                    <label for="portfolioSelector">현재 포트폴리오:</label>
                    <select id="portfolioSelector" class="input-group__select"></select>
                </div>
                <div class="btn-controls">
                    <button id="newPortfolioBtn" class="btn" data-variant="green">➕ 새로 만들기</button>
                    <button id="renamePortfolioBtn" class="btn" data-variant="blue">✏️ 이름 변경</button>
                    <button id="deletePortfolioBtn" class="btn" data-variant="orange">🗑️ 삭제</button>
                </div>
            </section>

            <section class="card" aria-labelledby="modeSelectionHeading">
                <h2 id="modeSelectionHeading">⚙️ 계산 모드 선택</h2>
                <div class="mode-selector">
                    <label for="modeSimple"><input type="radio" name="mainMode" value="simple" id="modeSimple" checked> 🎯 간단 계산 모드</label>
                    <label for="modeAdd"><input type="radio" name="mainMode" value="add" id="modeAdd"> ➕ 추가 매수 모드</label>
                    <label for="modeSell"><input type="radio" name="mainMode" value="sell" id="modeSell"> ⚖️ 매도 리밸런싱 모드</label>
                </div>
            </section>

            <section class="card" aria-labelledby="portfolioSettingsHeading">
                <h2 id="portfolioSettingsHeading">💼 현재 포트폴리오 설정</h2>
                 <div class="btn-controls">
                    <button id="addNewStockBtn" class="btn" data-variant="green">➕ 새 종목 추가</button>
                    <button id="fetchAllPricesBtn" class="btn w-full" data-variant="blue">📈 현재가 모두 불러오기</button>

                    <div id="allocationTemplateGroup" class="input-group mt-3">
                        <label for="allocationTemplate">📋 자산 배분 템플릿:</label>
                        <select id="allocationTemplate" class="input-select-custom">
                            <option value="">-- 템플릿 선택 --</option>
                            <option value="60-40">60/40 포트폴리오 (주식 60%, 채권 40%)</option>
                            <option value="all-weather">All-Weather (Ray Dalio)</option>
                            <option value="50-30-20">50/30/20 (주식 50%, 채권 30%, 기타 20%)</option>
                            <option value="equal">동일 비중</option>
                        </select>
                        <button id="applyTemplateBtn" class="btn mt-2" data-variant="blue">✨ 템플릿 적용</button>
                    </div>

                    <div id="portfolioExchangeRateGroup" class="input-group mt-3">
                        <label for="portfolioExchangeRate">💱 환율 (1 USD = ? KRW):</label>
                        <input type="number" id="portfolioExchangeRate" placeholder="예: 1300" min="0.01" step="0.01" value="1300">
                    </div>

                    <div id="rebalancingToleranceGroup" class="input-group mt-3">
                        <label for="rebalancingTolerance">🔔 리밸런싱 알림 허용 오차 (%):</label>
                        <input type="number" id="rebalancingTolerance" placeholder="예: 5" min="0" step="0.1" value="5">
                    </div>

                    <div id="tradingCostsGroup" class="input-group mt-3">
                        <label for="tradingFeeRate">💸 거래 수수료율 (%):</label>
                        <input type="number" id="tradingFeeRate" placeholder="예: 0.3" min="0" step="0.01" value="0.3">
                    </div>

                    <div id="taxRateGroup" class="input-group mt-3">
                        <label for="taxRate">💰 세율 (%):</label>
                        <input type="number" id="taxRate" placeholder="예: 15" min="0" step="0.1" value="15">
                    </div>

                    <button id="resetDataBtn" class="btn" data-variant="orange">🔄 초기화</button>
                    <button id="normalizeRatiosBtn" class="btn" data-variant="blue">⚖️ 비율 자동 맞춤(100%)</button>
                    
                    <div class="dropdown">
                        <button id="dataManagementBtn" class="btn" data-variant="grey" 
                                aria-haspopup="true" 
                                aria-expanded="false" 
                                aria-controls="dataDropdownContent">
                            💾 데이터 관리
                        </button>
                        <div id="dataDropdownContent" class="dropdown-content"
                             role="menu"
                             aria-labelledby="dataManagementBtn">
                            <a href="#" id="exportDataBtn" role="menuitem">📤 내보내기 (JSON)</a>
                            <a href="#" id="importDataBtn" role="menuitem">📥 가져오기 (JSON)</a>
                            <a href="#" id="exportTransactionsCSVBtn" role="menuitem">📊 거래 내역 CSV 내보내기</a>
                        </div>
                    </div>

                    <input type="file" id="importFileInput" accept=".json" class="d-none">
                </div>
                
                <div id="virtual-table-header" class="virtual-table-header" role="row">
                    </div>
                
                <div id="virtual-scroll-wrapper" role="grid" aria-rowcount="-1">
                    <div id="virtual-scroll-spacer"></div>
                    <div id="virtual-scroll-content"></div>
                </div>
                <div id="ratioValidator" class="ratio-validator">
                    <strong>목표 비율 합계:</strong>
                    <span class="ratio-value" id="ratioSum" aria-live="polite">0%</span>
                </div>
            </section>

             <section id="addInvestmentCard" class="card" aria-labelledby="addInvestmentHeading">
                <h2 id="addInvestmentHeading">💰 추가 투자금 계산</h2>
                 <div class="mode-selector">
                    <label for="currencyKRW"><input type="radio" name="currencyMode" value="krw" id="currencyKRW" checked> 원화(KRW) 기준</label>
                    <label for="currencyUSD"><input type="radio" name="currencyMode" value="usd" id="currencyUSD"> 달러(USD) 기준</label>
                </div>
                <div id="exchangeRateGroup" class="input-group hidden">
                    <label for="exchangeRate">환율 (1 USD):</label>
                    <input type="number" id="exchangeRate" placeholder="예: 1300" min="0.01" step="0.01" value="1300">
                </div>
                <div class="input-group">
                    <label for="additionalAmount">추가 투자 금액:</label>
                    <input type="number" id="additionalAmount" placeholder="예: 1000000" min="0">
                    <span id="usdInputGroup" class="hidden d-contents">
                        <span class="mx-2">또는</span>
                        <label for="additionalAmountUSD" class="hidden">USD</label>
                        <input type="number" id="additionalAmountUSD" placeholder="예: 1000" min="0" step="0.01">
                        <span>USD</span>
                    </span>
                </div>
            </section>

            <section id="rebalancingRulesCard" class="card" aria-labelledby="rebalancingRulesHeading">
                <h2 id="rebalancingRulesHeading">⚙️ 맞춤형 리밸런싱 규칙</h2>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="rebalancingRulesEnabled">
                        맞춤형 규칙 활성화
                    </label>
                </div>

                <div id="rebalancingRulesContent" class="hidden">
                    <div class="input-group mt-3">
                        <label for="bandPercentage">📊 목표 비율 허용 밴드 (±%):</label>
                        <input type="number" id="bandPercentage" placeholder="예: 5" min="0" step="0.1" value="5">
                        <small class="text-muted">목표 비율에서 이 범위 내에 있으면 리밸런싱하지 않습니다</small>
                    </div>

                    <div class="input-group mt-3">
                        <label for="minTradeAmount">💵 최소 거래 금액 (USD):</label>
                        <input type="number" id="minTradeAmount" placeholder="예: 100" min="0" step="1" value="100">
                        <small class="text-muted">이 금액 미만의 거래는 무시됩니다</small>
                    </div>

                    <div class="input-group mt-3">
                        <h3>📌 종목별 상한선</h3>
                        <div id="stockLimitsContainer"></div>
                        <button id="addStockLimitBtn" class="btn btn-sm mt-2" data-variant="green">+ 종목 상한선 추가</button>
                    </div>

                    <div class="input-group mt-3">
                        <h3>🏢 섹터별 상한선</h3>
                        <div id="sectorLimitsContainer"></div>
                        <button id="addSectorLimitBtn" class="btn btn-sm mt-2" data-variant="green">+ 섹터 상한선 추가</button>
                    </div>

                    <div class="input-group mt-3">
                        <h3>💾 프리셋 관리</h3>
                        <div class="btn-controls">
                            <select id="presetSelector" class="input-group__select">
                                <option value="">-- 프리셋 선택 --</option>
                            </select>
                            <button id="loadPresetBtn" class="btn btn-sm" data-variant="blue">불러오기</button>
                            <button id="savePresetBtn" class="btn btn-sm" data-variant="green">현재 설정 저장</button>
                            <button id="deletePresetBtn" class="btn btn-sm" data-variant="orange">삭제</button>
                        </div>
                    </div>
                </div>
            </section>

            <button id="calculateBtn" class="btn w-full p-4 text-lg mb-6">계산하기</button>

            <!-- Advanced Analysis Controls -->
            <section class="card mb-6" role="region" aria-label="고급 분석 기능">
                <h2>📊 고급 분석</h2>
                <div class="btn-controls mb-3">
                    <button id="showAssetTypeAllocationBtn" class="btn" data-variant="blue" title="자산 유형별 배분 분석">
                        🎯 자산 유형별 배분
                    </button>
                    <button id="showCountryAllocationBtn" class="btn" data-variant="green" title="국가별 배분 분석">
                        🌍 국가별 배분
                    </button>
                    <button id="showHeatmapBtn" class="btn" data-variant="purple" title="자산 배분 히트맵">
                        🔥 히트맵
                    </button>
                </div>
                <div class="btn-controls">
                    <button id="showTaxLotAnalysisBtn" class="btn" data-variant="orange" title="Tax-Lot 회계">
                        💰 Tax-Lot 분석
                    </button>
                    <button id="calculateTaxOptimizedSaleBtn" class="btn" data-variant="yellow" title="세금 최적화 매도">
                        📊 세금 최적화
                    </button>
                    <button id="showTransactionAnalysisBtn" class="btn" data-variant="cyan" title="거래 내역 분석">
                        📈 거래 내역 분석
                    </button>
                </div>
            </section>

            <section id="resultsSection" class="hidden" aria-live="polite" role="region" aria-label="계산 결과"></section>
            <section id="sectorAnalysisSection" class="hidden" role="region" aria-label="섹터별 분석 결과"></section>
            <section id="chartSection" class="card hidden" role="region" aria-label="포트폴리오 시각화 차트">
                <h2>📊 포트폴리오 시각화</h2>
                <div>
                    <canvas id="portfolioChart"></canvas>
                </div>
            </section>
            <section id="performanceHistorySection" class="card hidden" role="region" aria-label="포트폴리오 성과 히스토리">
                <h2>📈 포트폴리오 성과 히스토리</h2>
                <div class="btn-controls mb-4">
                    <button id="showPerformanceHistoryBtn" class="btn" data-variant="blue">📊 차트 보기</button>
                    <button id="showSnapshotListBtn" class="btn" data-variant="green">📋 스냅샷 목록</button>
                </div>
                <div id="performanceChartContainer" class="hidden">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div id="snapshotListContainer" class="hidden mb-4">
                    <h3>💾 저장된 스냅샷</h3>
                    <div id="snapshotList" class="snapshot-list-container"></div>
                </div>
            </section>

            <!-- Phase 4.14: 자산 배분 상세 뷰 -->
            <section id="assetAllocationSection" class="card hidden" role="region" aria-label="자산 유형별 배분">
                <h2>🎯 자산 유형별 배분</h2>
                <div class="chart-container mb-4" style="height: 400px;">
                    <canvas id="assetAllocationChart"></canvas>
                </div>
                <div id="assetAllocationTableContainer" class="mb-4"></div>
            </section>

            <section id="countryAllocationSection" class="card hidden" role="region" aria-label="국가별 배분">
                <h2>🌍 국가별 배분</h2>
                <div class="chart-container mb-4" style="height: 400px;">
                    <canvas id="countryAllocationChart"></canvas>
                </div>
                <div id="countryAllocationTableContainer" class="mb-4"></div>
            </section>

            <section id="heatmapSection" class="card hidden" role="region" aria-label="자산 배분 히트맵">
                <h2>🔥 자산 배분 히트맵</h2>
                <div id="heatmapContainer" class="mb-4"></div>
            </section>

            <!-- Phase 4.15: Tax-Lot Accounting -->
            <section id="taxLotSection" class="card hidden" role="region" aria-label="Tax-Lot 회계">
                <h2>💰 Tax-Lot 회계</h2>
                <div id="taxLotAnalysisContainer" class="mb-4"></div>
                <div id="taxOptimizedSaleContainer" class="mb-4"></div>
            </section>

            <!-- Phase 4.16: Transaction Analysis -->
            <section id="transactionAnalysisSection" class="card hidden" role="region" aria-label="거래 내역 분석">
                <h2>📈 거래 내역 분석</h2>
                <div id="transactionSummaryContainer" class="mb-4"></div>
            </section>

            <section id="dividendDashboardSection" class="card hidden" role="region" aria-label="배당금 대시보드">
                <h2>💰 배당금 대시보드</h2>

                <div class="dividend-summary mb-4">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <h3>총 배당금</h3>
                            <p id="totalDividendsAmount" class="amount-large">$0.00</p>
                        </div>
                        <div class="summary-card">
                            <h3>예상 연간 배당</h3>
                            <p id="estimatedAnnualDividend" class="amount-large">$0.00</p>
                            <small id="dividendYield" class="text-muted">수익률: 0.00%</small>
                        </div>
                    </div>
                </div>

                <div class="btn-controls mb-4">
                    <button id="showYearlyDividendsBtn" class="btn" data-variant="blue">📊 연도별 배당</button>
                    <button id="showMonthlyDividendsBtn" class="btn" data-variant="green">📅 월별 배당</button>
                    <button id="showDividendGrowthBtn" class="btn" data-variant="purple">📈 배당 성장률</button>
                </div>

                <div id="yearlyDividendsContainer" class="hidden mb-4">
                    <h3>📊 연도별 배당 내역</h3>
                    <div id="yearlyDividendsTable"></div>
                </div>

                <div id="monthlyDividendsContainer" class="hidden mb-4">
                    <h3>📅 월별 배당 (최근 12개월)</h3>
                    <div id="monthlyDividendsTable"></div>
                </div>

                <div id="dividendGrowthContainer" class="hidden mb-4">
                    <h3>📈 배당 성장률 (연도별)</h3>
                    <div id="dividendGrowthChart"></div>
                </div>
            </section>

            <section id="scenarioAnalysisSection" class="card hidden" role="region" aria-label="시나리오 분석">
                <h2>🎯 시나리오 분석</h2>

                <div class="scenario-summary mb-4">
                    <h3>현재 포트폴리오 가치</h3>
                    <p id="scenarioCurrentValue" class="amount-large">$0.00</p>
                </div>

                <div class="btn-controls mb-4">
                    <button id="analyzeScenarioBtn" class="btn" data-variant="blue">📊 시나리오 분석 실행</button>
                    <button id="customScenarioBtn" class="btn" data-variant="green">🎨 사용자 지정 시나리오</button>
                </div>

                <div id="scenarioResultsContainer" class="hidden mb-4">
                    <h3>📈 시장 변동 시나리오</h3>
                    <div id="scenarioResultsTable"></div>
                </div>

                <div id="customScenarioContainer" class="hidden mb-4">
                    <h3>🎨 사용자 지정 시나리오</h3>
                    <div class="input-group">
                        <label for="customMarketChange">시장 변동률 (%):</label>
                        <input type="number" id="customMarketChange" placeholder="예: 15 또는 -15" step="1" value="0">
                        <button id="runCustomScenarioBtn" class="btn btn-sm" data-variant="blue">분석 실행</button>
                    </div>
                    <div id="customScenarioResult" class="mt-3"></div>
                </div>
            </section>

            <section id="goalSimulatorSection" class="card hidden" role="region" aria-label="목표 달성 시뮬레이터">
                <h2>🎯 목표 달성 시뮬레이터</h2>

                <div class="goal-simulator-form mb-4">
                    <div class="input-group">
                        <label for="goalCurrentValue">현재 포트폴리오 가치 (USD):</label>
                        <input type="number" id="goalCurrentValue" placeholder="예: 10000" min="0" step="100" value="0">
                    </div>

                    <div class="input-group mt-3">
                        <label for="goalTargetAmount">목표 금액 (USD):</label>
                        <input type="number" id="goalTargetAmount" placeholder="예: 1000000" min="0" step="100" required>
                    </div>

                    <div class="input-group mt-3">
                        <label for="goalMonthlyContribution">월 적립금 (USD):</label>
                        <input type="number" id="goalMonthlyContribution" placeholder="예: 500" min="0" step="10" required>
                    </div>

                    <div class="input-group mt-3">
                        <label for="goalExpectedReturn">예상 연간 수익률 (%):</label>
                        <input type="number" id="goalExpectedReturn" placeholder="예: 7" min="-50" max="100" step="0.1" value="7">
                        <small class="text-muted">역사적 평균: S&P 500 ~10%, 채권 ~4-5%</small>
                    </div>

                    <div class="btn-controls mt-3">
                        <button id="simulateGoalBtn" class="btn" data-variant="blue">🎯 목표 달성 시뮬레이션</button>
                        <button id="calculateRequiredContributionBtn" class="btn" data-variant="green">💡 필요 적립금 계산</button>
                    </div>
                </div>

                <div id="goalSimulationResult" class="hidden mb-4">
                    <h3>시뮬레이션 결과</h3>
                    <div id="goalSimulationSummary"></div>
                    <div id="goalSimulationChart" class="mt-3"></div>
                </div>

                <div id="requiredContributionResult" class="hidden mb-4">
                    <h3>필요 적립금 계산 결과</h3>
                    <div class="input-group mb-3">
                        <label for="goalYearsToGoal">목표 달성 기간 (년):</label>
                        <input type="number" id="goalYearsToGoal" placeholder="예: 20" min="1" max="100" step="1" value="20">
                    </div>
                    <div id="requiredContributionSummary"></div>
                </div>
            </section>
        </main>
    </div>

    <div id="transactionModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalStockName">
        <div class="modal-content card">
            <div class="modal-header">
                <h2 id="modalStockName">거래 내역 관리</h2>
                <button id="closeModalBtn" class="modal-close-btn" aria-label="닫기">&times;</button>
            </div>
            
            <div class="table-responsive mb-4">
                <table id="transactionTable">
                    <caption>거래 내역 목록</caption>
                    <thead>
                        <tr>
                            <th>날짜</th><th>종류</th><th>수량</th><th>단가</th><th>총액</th><th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="transactionListBody"></tbody> </table>
            </div>

            <form id="newTransactionForm">
                <h3>새 거래 추가</h3>
                <div class="mode-selector mb-4">
                    <label><input type="radio" name="txType" value="buy" checked> 매수</label>
                    <label><input type="radio" name="txType" value="sell"> 매도</label>
                    <label><input type="radio" name="txType" value="dividend"> 배당</label>
                </div>
                <div class="mode-selector mb-4">
                    <label><input type="radio" name="inputMode" value="quantity" id="inputModeQuantity" checked> 수량 입력</label>
                    <label><input type="radio" name="inputMode" value="amount" id="inputModeAmount"> 금액 입력</label>
                </div>
                <div class="input-grid">
                    <div class="input-group-vertical">
                        <label for="txDate">날짜</label>
                        <input type="date" id="txDate" required>
                    </div>
                    <div class="input-group-vertical" id="quantityInputGroup">
                        <label for="txQuantity">수량</label>
                        <input type="number" id="txQuantity" placeholder="예: 10" min="0" step="any">
                    </div>
                    <div class="input-group-vertical d-none" id="totalAmountInputGroup">
                        <label for="txTotalAmount">총 금액</label>
                        <input type="number" id="txTotalAmount" placeholder="예: 1500000" min="0" step="any">
                    </div>
                    <div class="input-group-vertical">
                        <label for="txPrice">단가</label>
                        <input type="number" id="txPrice" placeholder="예: 150000" min="0" step="any" required>
                    </div>
                </div>
                <div id="calculatedQuantityDisplay" class="calculated-display d-none">
                    <strong>계산된 수량:</strong> <span id="calculatedQuantityValue">0</span>
                </div>
                <button type="submit" class="btn w-full mt-4" data-variant="blue">💾 거래 추가</button>
            </form>
        </div>
    </div>
    
    <div id="customModal" class="modal-overlay hidden" role="alertdialog" aria-modal="true" aria-labelledby="customModalTitle">
        <div class="modal-content card">
            <h2 id="customModalTitle"></h2>
            <p id="customModalMessage"></p>
            <input type="text" id="customModalInput" class="hidden w-full mt-4 mb-4">
            <div class="btn-controls btn-controls-end mt-4">
                <button id="customModalCancel" class="btn" data-variant="grey">취소</button>
                <button id="customModalConfirm" class="btn" data-variant="blue">확인</button>
            </div>
        </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
</body>
</html>