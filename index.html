<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ν¬νΈν΄λ¦¬μ¤ λ¦¬λ°Έλ°μ‹± κ³„μ‚°κΈ°</title>
    <meta name="description" content="ν¬νΈν΄λ¦¬μ¤ λ¦¬λ°Έλ°μ‹± κ³„μ‚°κΈ°λ¥Ό ν†µν•΄ λ©ν‘ λΉ„μ¨μ— λ§μ¶° ν¬μ μ „λµμ„ μµμ ν™”ν•μ„Έμ”.">

    <!-- Content Security Policy: Strict CSP with no unsafe directives -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' blob:;
        style-src 'self';
        img-src 'self' data: https:;
        font-src 'self' data:;
        connect-src 'self' https://finnhub.io https://api.exchangerate-api.com;
        base-uri 'self';
        form-action 'self';
        object-src 'none';
    ">

    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="aria-announcer" class="visually-hidden" aria-live="assertive" aria-atomic="true"></div>

    <button id="darkModeToggle" class="btn dark-mode-toggle" aria-label="λ‹¤ν¬ λ¨λ“ μ „ν™">π™</button>
    <div class="container">
        <header class="header">
            <h1>π“ ν¬νΈν΄λ¦¬μ¤ λ¦¬λ°Έλ°μ‹± κ³„μ‚°κΈ°</h1>
            <p>λ©ν‘ λΉ„μ¨μ— λ§μ¶° ν¬νΈν΄λ¦¬μ¤λ¥Ό μ΅°μ •ν•λ” μµμ μ λ°©λ²•μ„ κ³„μ‚°ν•©λ‹λ‹¤.</p>
        </header>

        <main>
            <section class="card" aria-labelledby="portfolioManagementHeading">
                <h2 id="portfolioManagementHeading">π“ ν¬νΈν΄λ¦¬μ¤ κ΄€λ¦¬</h2>
                <div class="input-group">
                    <label for="portfolioSelector">ν„μ¬ ν¬νΈν΄λ¦¬μ¤:</label>
                    <select id="portfolioSelector" class="input-group__select"></select>
                </div>
                <div class="btn-controls">
                    <button id="newPortfolioBtn" class="btn" data-variant="green">β• μƒλ΅ λ§λ“¤κΈ°</button>
                    <button id="renamePortfolioBtn" class="btn" data-variant="blue">βοΈ μ΄λ¦„ λ³€κ²½</button>
                    <button id="deletePortfolioBtn" class="btn" data-variant="orange">π—‘οΈ μ‚­μ </button>
                </div>
            </section>

            <section class="card" aria-labelledby="modeSelectionHeading">
                <h2 id="modeSelectionHeading">β™οΈ κ³„μ‚° λ¨λ“ μ„ νƒ</h2>
                <div class="mode-selector">
                    <label for="modeSimple"><input type="radio" name="mainMode" value="simple" id="modeSimple" checked> π― κ°„λ‹¨ κ³„μ‚° λ¨λ“</label>
                    <label for="modeAdd"><input type="radio" name="mainMode" value="add" id="modeAdd"> β• μ¶”κ°€ λ§¤μ λ¨λ“</label>
                    <label for="modeSell"><input type="radio" name="mainMode" value="sell" id="modeSell"> β–οΈ λ§¤λ„ λ¦¬λ°Έλ°μ‹± λ¨λ“</label>
                </div>
            </section>

            <section class="card" aria-labelledby="portfolioSettingsHeading">
                <h2 id="portfolioSettingsHeading">π’Ό ν„μ¬ ν¬νΈν΄λ¦¬μ¤ μ„¤μ •</h2>
                 <div class="btn-controls">
                    <button id="addNewStockBtn" class="btn" data-variant="green">β• μƒ μΆ…λ© μ¶”κ°€</button>
                    <button id="fetchAllPricesBtn" class="btn w-full" data-variant="blue">π“ ν„μ¬κ°€ λ¨λ‘ λ¶λ¬μ¤κΈ°</button>

                    <div id="allocationTemplateGroup" class="input-group mt-3">
                        <label for="allocationTemplate">π“‹ μμ‚° λ°°λ¶„ ν…ν”λ¦Ώ:</label>
                        <select id="allocationTemplate" class="input-select-custom">
                            <option value="">-- ν…ν”λ¦Ώ μ„ νƒ --</option>
                            <option value="60-40">60/40 ν¬νΈν΄λ¦¬μ¤ (μ£Όμ‹ 60%, μ±„κ¶ 40%)</option>
                            <option value="all-weather">All-Weather (Ray Dalio)</option>
                            <option value="50-30-20">50/30/20 (μ£Όμ‹ 50%, μ±„κ¶ 30%, κΈ°νƒ€ 20%)</option>
                            <option value="equal">λ™μΌ λΉ„μ¤‘</option>
                        </select>
                        <button id="applyTemplateBtn" class="btn mt-2" data-variant="blue">β¨ ν…ν”λ¦Ώ μ μ©</button>
                    </div>

                    <div id="portfolioExchangeRateGroup" class="input-group mt-3">
                        <label for="portfolioExchangeRate">π’± ν™μ¨ (1 USD = ? KRW):</label>
                        <input type="number" id="portfolioExchangeRate" placeholder="μ: 1300" min="0.01" step="0.01" value="1300">
                    </div>

                    <div id="rebalancingToleranceGroup" class="input-group mt-3">
                        <label for="rebalancingTolerance">π”” λ¦¬λ°Έλ°μ‹± μ•λ¦Ό ν—μ© μ¤μ°¨ (%):</label>
                        <input type="number" id="rebalancingTolerance" placeholder="μ: 5" min="0" step="0.1" value="5">
                    </div>

                    <div id="tradingCostsGroup" class="input-group mt-3">
                        <label for="tradingFeeRate">π’Έ κ±°λ μμλ£μ¨ (%):</label>
                        <input type="number" id="tradingFeeRate" placeholder="μ: 0.3" min="0" step="0.01" value="0.3">
                    </div>

                    <div id="taxRateGroup" class="input-group mt-3">
                        <label for="taxRate">π’° μ„Έμ¨ (%):</label>
                        <input type="number" id="taxRate" placeholder="μ: 15" min="0" step="0.1" value="15">
                    </div>

                    <button id="resetDataBtn" class="btn" data-variant="orange">π”„ μ΄κΈ°ν™”</button>
                    <button id="normalizeRatiosBtn" class="btn" data-variant="blue">β–οΈ λΉ„μ¨ μλ™ λ§μ¶¤(100%)</button>
                    
                    <div class="dropdown">
                        <button id="dataManagementBtn" class="btn" data-variant="grey" 
                                aria-haspopup="true" 
                                aria-expanded="false" 
                                aria-controls="dataDropdownContent">
                            π’Ύ λ°μ΄ν„° κ΄€λ¦¬
                        </button>
                        <div id="dataDropdownContent" class="dropdown-content"
                             role="menu"
                             aria-labelledby="dataManagementBtn">
                            <a href="#" id="exportDataBtn" role="menuitem">π“¤ λ‚΄λ³΄λ‚΄κΈ° (JSON)</a>
                            <a href="#" id="importDataBtn" role="menuitem">π“¥ κ°€μ Έμ¤κΈ° (JSON)</a>
                            <a href="#" id="exportTransactionsCSVBtn" role="menuitem">π“ κ±°λ λ‚΄μ—­ CSV λ‚΄λ³΄λ‚΄κΈ°</a>
                        </div>
                    </div>

                    <input type="file" id="importFileInput" accept=".json" class="d-none">
                </div>
                
                <div id="virtual-table-header" class="virtual-table-header" role="row">
                    </div>
                
                <div id="virtual-scroll-wrapper" role="grid" aria-rowcount="-1">
                    <div id="virtual-scroll-spacer"></div>
                    <div id="virtual-scroll-content"></div>
                </div>
                <div id="ratioValidator" class="ratio-validator">
                    <strong>λ©ν‘ λΉ„μ¨ ν•©κ³„:</strong>
                    <span class="ratio-value" id="ratioSum" aria-live="polite">0%</span>
                </div>
            </section>

             <section id="addInvestmentCard" class="card" aria-labelledby="addInvestmentHeading">
                <h2 id="addInvestmentHeading">π’° μ¶”κ°€ ν¬μκΈ κ³„μ‚°</h2>
                 <div class="mode-selector">
                    <label for="currencyKRW"><input type="radio" name="currencyMode" value="krw" id="currencyKRW" checked> μ›ν™”(KRW) κΈ°μ¤€</label>
                    <label for="currencyUSD"><input type="radio" name="currencyMode" value="usd" id="currencyUSD"> λ‹¬λ¬(USD) κΈ°μ¤€</label>
                </div>
                <div id="exchangeRateGroup" class="input-group hidden">
                    <label for="exchangeRate">ν™μ¨ (1 USD):</label>
                    <input type="number" id="exchangeRate" placeholder="μ: 1300" min="0.01" step="0.01" value="1300">
                </div>
                <div class="input-group">
                    <label for="additionalAmount">μ¶”κ°€ ν¬μ κΈμ•΅:</label>
                    <input type="number" id="additionalAmount" placeholder="μ: 1000000" min="0">
                    <span id="usdInputGroup" class="hidden d-contents">
                        <span class="mx-2">λλ”</span>
                        <label for="additionalAmountUSD" class="hidden">USD</label>
                        <input type="number" id="additionalAmountUSD" placeholder="μ: 1000" min="0" step="0.01">
                        <span>USD</span>
                    </span>
                </div>
            </section>

            <section id="rebalancingRulesCard" class="card" aria-labelledby="rebalancingRulesHeading">
                <h2 id="rebalancingRulesHeading">β™οΈ λ§μ¶¤ν• λ¦¬λ°Έλ°μ‹± κ·μΉ™</h2>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="rebalancingRulesEnabled">
                        λ§μ¶¤ν• κ·μΉ™ ν™μ„±ν™”
                    </label>
                </div>

                <div id="rebalancingRulesContent" class="hidden">
                    <div class="input-group mt-3">
                        <label for="bandPercentage">π“ λ©ν‘ λΉ„μ¨ ν—μ© λ°΄λ“ (Β±%):</label>
                        <input type="number" id="bandPercentage" placeholder="μ: 5" min="0" step="0.1" value="5">
                        <small class="text-muted">λ©ν‘ λΉ„μ¨μ—μ„ μ΄ λ²”μ„ λ‚΄μ— μμΌλ©΄ λ¦¬λ°Έλ°μ‹±ν•μ§€ μ•μµλ‹λ‹¤</small>
                    </div>

                    <div class="input-group mt-3">
                        <label for="minTradeAmount">π’µ μµμ† κ±°λ κΈμ•΅ (USD):</label>
                        <input type="number" id="minTradeAmount" placeholder="μ: 100" min="0" step="1" value="100">
                        <small class="text-muted">μ΄ κΈμ•΅ λ―Έλ§μ κ±°λλ” λ¬΄μ‹λ©λ‹λ‹¤</small>
                    </div>

                    <div class="input-group mt-3">
                        <h3>π“ μΆ…λ©λ³„ μƒν•μ„ </h3>
                        <div id="stockLimitsContainer"></div>
                        <button id="addStockLimitBtn" class="btn btn-sm mt-2" data-variant="green">+ μΆ…λ© μƒν•μ„  μ¶”κ°€</button>
                    </div>

                    <div class="input-group mt-3">
                        <h3>πΆ μ„Ήν„°λ³„ μƒν•μ„ </h3>
                        <div id="sectorLimitsContainer"></div>
                        <button id="addSectorLimitBtn" class="btn btn-sm mt-2" data-variant="green">+ μ„Ήν„° μƒν•μ„  μ¶”κ°€</button>
                    </div>

                    <div class="input-group mt-3">
                        <h3>π’Ύ ν”„λ¦¬μ…‹ κ΄€λ¦¬</h3>
                        <div class="btn-controls">
                            <select id="presetSelector" class="input-group__select">
                                <option value="">-- ν”„λ¦¬μ…‹ μ„ νƒ --</option>
                            </select>
                            <button id="loadPresetBtn" class="btn btn-sm" data-variant="blue">λ¶λ¬μ¤κΈ°</button>
                            <button id="savePresetBtn" class="btn btn-sm" data-variant="green">ν„μ¬ μ„¤μ • μ €μ¥</button>
                            <button id="deletePresetBtn" class="btn btn-sm" data-variant="orange">μ‚­μ </button>
                        </div>
                    </div>
                </div>
            </section>

            <button id="calculateBtn" class="btn w-full p-4 text-lg mb-6">κ³„μ‚°ν•κΈ°</button>
            
            <section id="resultsSection" class="hidden" aria-live="polite" role="region" aria-label="κ³„μ‚° κ²°κ³Ό"></section>
            <section id="sectorAnalysisSection" class="hidden" role="region" aria-label="μ„Ήν„°λ³„ λ¶„μ„ κ²°κ³Ό"></section>
            <section id="chartSection" class="card hidden" role="region" aria-label="ν¬νΈν΄λ¦¬μ¤ μ‹κ°ν™” μ°¨νΈ">
                <h2>π“ ν¬νΈν΄λ¦¬μ¤ μ‹κ°ν™”</h2>
                <div>
                    <canvas id="portfolioChart"></canvas>
                </div>
            </section>
            <section id="performanceHistorySection" class="card hidden" role="region" aria-label="ν¬νΈν΄λ¦¬μ¤ μ„±κ³Ό νμ¤ν† λ¦¬">
                <h2>π“ ν¬νΈν΄λ¦¬μ¤ μ„±κ³Ό νμ¤ν† λ¦¬</h2>
                <div class="btn-controls mb-4">
                    <button id="showPerformanceHistoryBtn" class="btn" data-variant="blue">π“ μ°¨νΈ λ³΄κΈ°</button>
                    <button id="showSnapshotListBtn" class="btn" data-variant="green">π“‹ μ¤λƒ…μƒ· λ©λ΅</button>
                </div>
                <div id="performanceChartContainer" class="hidden">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div id="snapshotListContainer" class="hidden mb-4">
                    <h3>π’Ύ μ €μ¥λ μ¤λƒ…μƒ·</h3>
                    <div id="snapshotList" class="snapshot-list-container"></div>
                </div>
            </section>

            <section id="dividendDashboardSection" class="card hidden" role="region" aria-label="λ°°λ‹ΉκΈ λ€μ‹λ³΄λ“">
                <h2>π’° λ°°λ‹ΉκΈ λ€μ‹λ³΄λ“</h2>

                <div class="dividend-summary mb-4">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <h3>μ΄ λ°°λ‹ΉκΈ</h3>
                            <p id="totalDividendsAmount" class="amount-large">$0.00</p>
                        </div>
                        <div class="summary-card">
                            <h3>μμƒ μ—°κ°„ λ°°λ‹Ή</h3>
                            <p id="estimatedAnnualDividend" class="amount-large">$0.00</p>
                            <small id="dividendYield" class="text-muted">μμµλ¥ : 0.00%</small>
                        </div>
                    </div>
                </div>

                <div class="btn-controls mb-4">
                    <button id="showYearlyDividendsBtn" class="btn" data-variant="blue">π“ μ—°λ„λ³„ λ°°λ‹Ή</button>
                    <button id="showMonthlyDividendsBtn" class="btn" data-variant="green">π“… μ›”λ³„ λ°°λ‹Ή</button>
                    <button id="showDividendGrowthBtn" class="btn" data-variant="purple">π“ λ°°λ‹Ή μ„±μ¥λ¥ </button>
                </div>

                <div id="yearlyDividendsContainer" class="hidden mb-4">
                    <h3>π“ μ—°λ„λ³„ λ°°λ‹Ή λ‚΄μ—­</h3>
                    <div id="yearlyDividendsTable"></div>
                </div>

                <div id="monthlyDividendsContainer" class="hidden mb-4">
                    <h3>π“… μ›”λ³„ λ°°λ‹Ή (μµκ·Ό 12κ°μ›”)</h3>
                    <div id="monthlyDividendsTable"></div>
                </div>

                <div id="dividendGrowthContainer" class="hidden mb-4">
                    <h3>π“ λ°°λ‹Ή μ„±μ¥λ¥  (μ—°λ„λ³„)</h3>
                    <div id="dividendGrowthChart"></div>
                </div>
            </section>
        </main>
    </div>

    <div id="transactionModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalStockName">
        <div class="modal-content card">
            <div class="modal-header">
                <h2 id="modalStockName">κ±°λ λ‚΄μ—­ κ΄€λ¦¬</h2>
                <button id="closeModalBtn" class="modal-close-btn" aria-label="λ‹«κΈ°">&times;</button>
            </div>
            
            <div class="table-responsive mb-4">
                <table id="transactionTable">
                    <caption>κ±°λ λ‚΄μ—­ λ©λ΅</caption>
                    <thead>
                        <tr>
                            <th>λ‚ μ§</th><th>μΆ…λ¥</th><th>μλ‰</th><th>λ‹¨κ°€</th><th>μ΄μ•΅</th><th>μ‘μ—…</th>
                        </tr>
                    </thead>
                    <tbody id="transactionListBody"></tbody> </table>
            </div>

            <form id="newTransactionForm">
                <h3>μƒ κ±°λ μ¶”κ°€</h3>
                <div class="mode-selector mb-4">
                    <label><input type="radio" name="txType" value="buy" checked> λ§¤μ</label>
                    <label><input type="radio" name="txType" value="sell"> λ§¤λ„</label>
                    <label><input type="radio" name="txType" value="dividend"> λ°°λ‹Ή</label>
                </div>
                <div class="mode-selector mb-4">
                    <label><input type="radio" name="inputMode" value="quantity" id="inputModeQuantity" checked> μλ‰ μ…λ ¥</label>
                    <label><input type="radio" name="inputMode" value="amount" id="inputModeAmount"> κΈμ•΅ μ…λ ¥</label>
                </div>
                <div class="input-grid">
                    <div class="input-group-vertical">
                        <label for="txDate">λ‚ μ§</label>
                        <input type="date" id="txDate" required>
                    </div>
                    <div class="input-group-vertical" id="quantityInputGroup">
                        <label for="txQuantity">μλ‰</label>
                        <input type="number" id="txQuantity" placeholder="μ: 10" min="0" step="any">
                    </div>
                    <div class="input-group-vertical d-none" id="totalAmountInputGroup">
                        <label for="txTotalAmount">μ΄ κΈμ•΅</label>
                        <input type="number" id="txTotalAmount" placeholder="μ: 1500000" min="0" step="any">
                    </div>
                    <div class="input-group-vertical">
                        <label for="txPrice">λ‹¨κ°€</label>
                        <input type="number" id="txPrice" placeholder="μ: 150000" min="0" step="any" required>
                    </div>
                </div>
                <div id="calculatedQuantityDisplay" class="calculated-display d-none">
                    <strong>κ³„μ‚°λ μλ‰:</strong> <span id="calculatedQuantityValue">0</span>
                </div>
                <button type="submit" class="btn w-full mt-4" data-variant="blue">π’Ύ κ±°λ μ¶”κ°€</button>
            </form>
        </div>
    </div>
    
    <div id="customModal" class="modal-overlay hidden" role="alertdialog" aria-modal="true" aria-labelledby="customModalTitle">
        <div class="modal-content card">
            <h2 id="customModalTitle"></h2>
            <p id="customModalMessage"></p>
            <input type="text" id="customModalInput" class="hidden w-full mt-4 mb-4">
            <div class="btn-controls btn-controls-end mt-4">
                <button id="customModalCancel" class="btn" data-variant="grey">μ·¨μ†</button>
                <button id="customModalConfirm" class="btn" data-variant="blue">ν™•μΈ</button>
            </div>
        </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
</body>
</html>